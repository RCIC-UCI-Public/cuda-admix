!include cuda-common.yaml
---
- package: CUDA Driver Run file 
  name: "{{cuda.name}}-driver"
  description_add: NVIDIA driver {{cuda.driver}} installer files file into the {{root}} tree
  installer: NVIDIA-Linux-x86_64-{{cuda.driver}}.run
  cmdfile: disable-nouveau.yml 
  systemd_dir: /etc/systemd/system
  service_in: nvidia-installer.service.in
  service: nvidia-installer.service
  addfile:
    - "{{cmdfile}}" 
    - installer.sh
    - "{{service_in}}"
  install:
    makeinstall: "{{install.driver_install}}"
    driver_install: >
      for x in {{installer}}; do  cp -pR {{extractDir2}}/$$x $(ROOT){{root}}; done;
      $(INSTALL) {{cmdfile}} $(ROOT)/{{root}};
      $(INSTALL) -m 500 installer.sh $(ROOT)/{{root}};
      sed -i 's/%VERSION%/{{version}}/' $(ROOT)/{{root}}/installer.sh;
      mkdir -p $(ROOT)/{{systemd_dir}};
      sed 's@%PATH%@{{root}}@' {{service_in}} > $(ROOT)/{{systemd_dir}}/{{service}}
  files:
    - "{{parent}}"
    - "{{systemd_dir}}/*"
  conflicts: "{{name}}_{{versions.cuda.conflicts}}"
